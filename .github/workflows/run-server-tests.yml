name: Run Server Tests

run-name: Running Server Tests for ${{ github.ref }}

on: [push]

env:
  PG_USER: brave
  PG_USER_TEST: brave
  PG_DATABASE: brave
  PG_DATABASE_TEST: brave
  PG_PASSWORD: actionspassword
  PG_PASSWORD_TEST: actionspassword
  PG_PORT: 5432
  PG_PORT_TEST: 5432
  PG_HOST: localhost
  PG_HOST_TEST: localhost
  WEB_USERNAME_TEST: ActionsDashboardUsername
  PASSWORD_TEST: ActionsDashboardPassword
  SECRET_TEST: ActionsCookieSecret
  SESSION_RESET_THRESHOLD_TEST: 2000
  SESSION_NUMBER_OF_ALERTS_TO_ACCEPT_RESET_REQUEST_TEST: 4
  PARTICLE_PRODUCT_GROUP_TEST: product-123
  LOW_BATTERY_ALERT_TIMEOUT_TEST: 2
  MAX_STILLNESS_ALERTS_TEST: 2
  INTERVAL_TO_CHECK_ALERTS_TEST: 60
  SUBSEQUENT_VITALS_ALERT_THRESHOLD_TEST: 2
  PA_API_KEY_PRIMARY_TEST: primaryPAkey
  PA_API_KEY_SECONDARY_TEST: secondaryPAkey
  PA_CLIENT_ID_TEST: fakeclientid.apps.googleusercontent.com
  PA_CLIENT_SECRET_TEST: fakeclientsecret
  PARTICLE_WEBHOOK_API_KEY_TEST: webhookKey

jobs:
  ServerTests:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:12
        env:
          POSTGRES_DB: brave
          POSTGRES_PASSWORD: actionspassword
          POSTGRES_PORT: 5432
          POSTGRES_USER: brave
    steps:
      - uses: actions/checkout@v4
      - name: Setup PostgreSQL
        run: |
          cd server
          ./setup_postgresql.sh $PG_PASSWORD $PG_USER $PG_HOST $PG_DATABASE $PG_PORT
          cd ..
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
      - name: Install Node.js packages
        run: npm --prefix server ci
      - name: Run server tests
        run: |
          npm --prefix server run lint
          npm --prefix server run test
