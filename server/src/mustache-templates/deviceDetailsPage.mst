<!DOCTYPE html>
<html lang="en">

<head>
    <title>Brave Sensor Dashboard</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    {{> css}}
</head>

<body>
    {{> nav}}
    <div class="content-area">
        <div class="content-wrapper">
        {{#device}}
            <h3>Device:  {{displayName}}</h3>
            <a href="/devices/{{deviceId}}/update" class="btn btn-secondary btn-sm" role="button">Update Device</a>
            <a href="/clients/{{clientId}}" class="btn btn-secondary btn-sm" role="button">View Client</a>
            <br>
            <br>
            <br>

            <h5>Latest Vital</h5>
            <div class="info-box">
                {{#latestVital}}
                <p><strong>Device Last Seen At:</strong> {{timeSinceLastVital}}</p>
                <p><strong>Door Last Seen At:</strong> {{timeSinceLastDoorContact}}</p>
                <p><strong>Door Battery Low:</strong> {{#doorLowBattery}}Yes{{/doorLowBattery}}{{^doorLowBattery}}No{{/doorLowBattery}}</p>
                <p><strong>Door Tampered:</strong> {{#doorTampered}}Yes{{/doorTampered}}{{^doorTampered}}No{{/doorTampered}}</p>
                {{/latestVital}}
                {{^latestVital}}
                <p>No vital information available</p>
                {{/latestVital}}
                <br>
                <a href="/notifications/{{deviceId}}" class="btn btn-secondary btn-sm" role="button">View Notifications</a>
            </div>
            <br>
            
            <h5>Sessions</h5>
            <div class="table-responsive">
                <table class="table table-striped table-sm table-fixed">
                    <thead>
                        <tr class="table-header" scope="row">
                            <th scope="col">Session ID</th>
                            <th scope="col">Created At</th>
                            <th scope="col">Session Status</th>
                            <th scope="col">Response Time</th>
                            <th scope="col">Survey Category</th>
                            <th scope="col">Send Message</th>
                            <th scope="col">Send Test Alert</th>
                        </tr>
                    </thead>
                    <tbody>
                    {{#allSessions}}
                        <tr class="table-data">
                            <th scope="row"><a href="/sessions/{{sessionId}}">{{sessionId}}</a></th>
                            <td>{{#formatDate}}{{createdAt}}{{/formatDate}}</td>
                            <td>{{sessionStatus}}</td>
                            <td>{{#responseTime}}{{responseTime.minutes}}m {{responseTime.seconds}}s{{/responseTime}}{{^responseTime}}N/A{{/responseTime}}</td>
                            <td>{{#selectedSurveyCategory}}{{selectedSurveyCategory}}{{/selectedSurveyCategory}}{{^selectedSurveyCategory}}N/A{{/selectedSurveyCategory}}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="showMessageModal('{{deviceId}}')">Send Message</button>
                            </td>
                            <td>
                                <button class="btn btn-warning btn-sm" onclick="showTestAlertModal('{{deviceId}}')">Send Test Alert</button>
                            </td>
                        </tr>
                    {{/allSessions}}
                    </tbody>
                </table>
            </div>
            <br>
            
            <h5>Troubleshooting</h5>
            <div class="info-box">
                <button class="btn btn-primary" onclick="showMessageModal('{{deviceId}}')">Send Custom Message</button>
                <button class="btn btn-warning" onclick="showTestAlertModal('{{deviceId}}')">Send Test Alert</button>
            </div>
            <br>

        {{/device}}
        {{^device}}
            <h5>Sorry, this device does not appear to exist.</h5>
        {{/device}}
        </div>
    </div>
    
    <!-- Message Modal -->
    <div class="modal fade" id="messageModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Send Custom Message</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <form id="messageForm" method="POST" action="/devices/{{device.deviceId}}/send-message">
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <strong>Device:</strong> {{device.displayName}}<br>
                            You can include the device name in your message using <code>{deviceName}</code>
                            {{#client.responderPhoneNumbers}}
                            <hr>
                            <strong>Message will be sent to:</strong><br>
                            {{#client.responderPhoneNumbers}}
                            <span class="badge badge-primary">{{.}}</span>
                            {{/client.responderPhoneNumbers}}
                            {{/client.responderPhoneNumbers}}
                            {{^client.responderPhoneNumbers}}
                            <hr>
                            <strong class="text-danger">⚠️ No responder phone numbers configured</strong>
                            {{/client.responderPhoneNumbers}}
                        </div>
                        <div class="form-group">
                            <label for="messageText">Message:</label>
                            <textarea class="form-control" id="messageText" name="message" rows="4" required></textarea>
                            <small class="form-text text-muted">Use {deviceName} to insert the device name</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Send Message</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Test Alert Modal -->
    <div class="modal fade" id="testAlertModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Send Test Alert</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <form id="testAlertForm" method="POST" action="/devices/{{device.deviceId}}/send-test-alert">
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <strong>⚠️ Warning:</strong> This will send a <strong>TEST ALERT</strong> to all responders for device <strong>{{device.displayName}}</strong>.<br>
                            The alert will be clearly labeled as a test and will auto-populate the survey category as "test".
                            {{#client.responderPhoneNumbers}}
                            <hr>
                            <strong>Alert will be sent to:</strong><br>
                            {{#client.responderPhoneNumbers}}
                            <span class="badge badge-warning">{{.}}</span>
                            {{/client.responderPhoneNumbers}}
                            {{/client.responderPhoneNumbers}}
                            {{^client.responderPhoneNumbers}}
                            <hr>
                            <strong class="text-danger">⚠️ No responder phone numbers configured</strong>
                            {{/client.responderPhoneNumbers}}
                        </div>
                        <div class="form-group">
                            <label for="alertType">Alert Type:</label>
                            <select class="form-control" id="alertType" name="alertType" required>
                                <option value="stillness">Stillness Alert</option>
                                <option value="duration">Duration Alert</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning">Send Test Alert</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        function showMessageModal(deviceId) {
            $('#messageModal').modal('show')
        }
        
        function showTestAlertModal(deviceId) {
            $('#testAlertModal').modal('show')
        }
        
        $('#messageForm').on('submit', function(e) {
            if (!confirm('Are you sure you want to send this message?')) {
                e.preventDefault()
                return false
            }
        })
        
        $('#testAlertForm').on('submit', function(e) {
            if (!confirm('Are you sure you want to send a TEST ALERT? This will notify all responders.')) {
                e.preventDefault()
                return false
            }
        })
    </script>
    
    <script>
        function reloadPage() {
            location.reload(true)
        }
        setInterval(reloadPage, 30000)
    </script>
    
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</body>
</html>
